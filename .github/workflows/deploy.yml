name: Deploy to Azure VM

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Azure VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_USERNAME }}
          key: ${{ secrets.AZURE_SSH_KEY }}
          port: 22
          script: |
            echo "Starting deployment..."

            APP_DIR="$HOME/repo-db"

            if [ ! -d "$APP_DIR" ]; then
              echo "Creating $APP_DIR directory..."
              mkdir -p $APP_DIR
            fi

            cd $APP_DIR
            echo "Working directory: $APP_DIR"

            echo "Updating git repository..."
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "Initializing git repository..."
              git init
              git remote add origin https://github.com/volodiagamivka/repo-db.git || git remote set-url origin https://github.com/volodiagamivka/repo-db.git
              git fetch origin
              git checkout -b main || git checkout main
              git reset --hard origin/main
            fi

            echo "Cleaning Python cache..."
            find $APP_DIR -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
            find $APP_DIR -type f -name "*.pyc" -delete 2>/dev/null || true
            find $APP_DIR -type f -name "*.pyo" -delete 2>/dev/null || true

            if [ -d "venv" ]; then
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt --upgrade --quiet
            else
              echo "Creating new venv..."
              python3 -m venv venv
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            fi

            echo "Updating systemd service to use $APP_DIR..."
            sudo tee /etc/systemd/system/hospital-api.service > /dev/null <<EOF
            [Unit]
            Description=Hospital Management API
            After=network.target

            [Service]
            Type=notify
            User=$USER
            WorkingDirectory=$APP_DIR
            Environment="PATH=$APP_DIR/venv/bin"
            ExecStart=$APP_DIR/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 4 --timeout 120 --access-logfile - --error-logfile - app:app
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            EOF

            echo "Reloading systemd daemon..."
            sudo systemctl daemon-reload

            echo "Stopping service completely..."
            sudo systemctl stop hospital-api || true
            sleep 2

            # Kill any remaining gunicorn processes
            sudo pkill -f "gunicorn.*app:app" || true
            sleep 1

            echo "Starting service..."
            sudo systemctl start hospital-api

            echo "Waiting for service to start..."
            sleep 8

            echo "Checking service status..."
            sudo systemctl status hospital-api --no-pager || true

            echo "Verifying service is active..."
            if sudo systemctl is-active --quiet hospital-api; then
              echo "✅ Service is running successfully!"
              echo "Checking if service is listening on port 5000..."
              sleep 2
              if sudo netstat -tlnp | grep :5000 || sudo ss -tlnp | grep :5000; then
                echo "✅ Service is listening on port 5000!"
              else
                echo "⚠️ Service is running but not listening on port 5000"
              fi
            else
              echo "❌ Service failed to start!"
              echo "Checking service logs..."
              sudo journalctl -u hospital-api -n 50 --no-pager
              exit 1
            fi

            echo "Deployment completed!"
